# =============================================================================
# 4XL - GitHub Actions CI/CD
# Automatically deploys to HuggingFace Spaces on push to main
# =============================================================================

name: Deploy to HuggingFace Spaces

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'frontend/**'
  workflow_dispatch:  # Allow manual trigger

jobs:
  # Deploy Backend (Gradio API)
  deploy-backend:
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' ||
      contains(join(github.event.commits.*.modified, ','), 'backend/') ||
      contains(join(github.event.commits.*.added, ','), 'backend/')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Deploy Backend to HuggingFace
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          # Clone existing HF Space (preserves history)
          git clone https://mahinigam:$HF_TOKEN@huggingface.co/spaces/mahinigam/4xl-api /tmp/hf-backend
          
          # Sync backend/ files → HF Space (excluding .git)
          rsync -av --delete --exclude '.git' backend/ /tmp/hf-backend/
          
          cd /tmp/hf-backend
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          
          # Only push if there are actual changes
          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes to deploy for backend"
          else
            git add -A
            git commit -m "deploy: backend from GitHub @ $(git -C $GITHUB_WORKSPACE rev-parse --short HEAD)"
            git push
            echo "✅ Backend deployed to HuggingFace"
          fi

  # Deploy Frontend (React + Docker)
  deploy-frontend:
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' ||
      contains(join(github.event.commits.*.modified, ','), 'frontend/') ||
      contains(join(github.event.commits.*.added, ','), 'frontend/')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Deploy Frontend to HuggingFace
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          # Clone existing HF Space (preserves history)
          git clone https://mahinigam:$HF_TOKEN@huggingface.co/spaces/mahinigam/4xl /tmp/hf-frontend
          
          # Sync frontend/ files → HF Space (excluding .git, node_modules, dist, .env)
          rsync -av --delete \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude 'dist' \
            --exclude '.env' \
            frontend/ /tmp/hf-frontend/
          
          cd /tmp/hf-frontend
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          
          # Only push if there are actual changes
          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes to deploy for frontend"
          else
            git add -A
            git commit -m "deploy: frontend from GitHub @ $(git -C $GITHUB_WORKSPACE rev-parse --short HEAD)"
            git push
            echo "✅ Frontend deployed to HuggingFace"
          fi
